<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TauriPets - Battle Pet Collection Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0d0d1a 0%, #1a1a2e 25%, #16213e 50%, #1a1a2e 75%, #0d0d1a 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
            position: relative;
        }
        
        /* Subtle fantasy overlay pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(ellipse at 20% 80%, rgba(138, 43, 226, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(0, 255, 136, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(255, 215, 0, 0.03) 0%, transparent 70%);
            pointer-events: none;
            z-index: -1;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #00ff88;
            font-size: 2.5rem;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.5), 0 0 40px rgba(0, 255, 136, 0.3);
            margin-bottom: 5px;
            letter-spacing: 2px;
        }
        
        /* WoW-style gold accent bar */
        header::after {
            content: '';
            display: block;
            width: 200px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #ffd700, transparent);
            margin: 15px auto 0;
        }
        
        .header-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            color: white;
            text-decoration: none;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
            border: 1px solid rgba(139, 92, 246, 0.5);
        }
        
        .download-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(139, 92, 246, 0.4);
            background: linear-gradient(135deg, #9d6fff, #7c3aed);
        }
        
        .github-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
            text-decoration: none;
            border-radius: 20px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .github-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }
        
        .subtitle {
            color: #888;
            font-size: 1rem;
        }
        
        .disclaimer {
            color: #ff9800;
            font-size: 0.75rem;
            margin-top: 8px;
            padding: 6px 12px;
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid rgba(255, 152, 0, 0.3);
            border-radius: 15px;
            display: inline-block;
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 12px 30px;
            border: 2px solid #00ff88;
            border-radius: 25px;
            background: rgba(0, 0, 0, 0.3);
            color: #00ff88;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }
        
        .tab-btn:hover {
            background: rgba(0, 255, 136, 0.15);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #1a1a2e;
            text-shadow: none;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Upload Area */
        .upload-area {
            border: 3px dashed #00ff88;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 25px;
            background: rgba(0, 255, 136, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover, .upload-area.dragover {
            background: rgba(0, 255, 136, 0.15);
            border-color: #00ffaa;
        }
        
        .upload-area h2 {
            color: #00ff88;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }
        
        .upload-area p {
            color: #aaa;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .upload-area input[type="file"] {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #1a1a2e;
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .upload-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
        }
        
        .file-path {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.8rem;
            color: #ffd700;
            word-break: break-all;
        }
        
        /* Stats Dashboard */
        .stats-dashboard {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .stats-dashboard.visible {
            display: grid;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00ff88;
        }
        
        .stat-card .label {
            color: #888;
            font-size: 0.8rem;
            margin-top: 3px;
        }
        
        .stat-card.rare .value { color: #1eff00; }
        .stat-card.epic .value { color: #0070dd; }
        .stat-card.legendary .value { color: #a335ee; }
        
        /* Score Display */
        .score-display {
            display: none;
            text-align: center;
            margin-bottom: 25px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 140, 0, 0.05));
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .score-display::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, transparent 70%);
            animation: pulse-glow 3s ease-in-out infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }
        
        .score-display.visible {
            display: block;
        }
        
        .score-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }
        
        .score-value {
            font-size: 3rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 215, 0, 0.3);
            position: relative;
            z-index: 1;
        }
        
        .score-breakdown {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }
        
        .score-part {
            font-size: 0.8rem;
            color: #888;
        }
        
        .score-part span {
            color: #fff;
            font-weight: bold;
        }
        
        /* Achievements */
        .achievements {
            display: none;
            margin-bottom: 25px;
        }
        
        .achievements.visible {
            display: block;
        }
        
        .achievements h3 {
            color: #ffd700;
            font-size: 1rem;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .achievement-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        
        .achievement {
            padding: 6px 12px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            font-size: 0.8rem;
            color: #ffd700;
        }
        
        .achievement.locked {
            background: rgba(100, 100, 100, 0.1);
            border-color: rgba(100, 100, 100, 0.3);
            color: #555;
        }
        
        /* Progress Bar */
        .progress-container {
            display: none;
            margin-bottom: 25px;
        }
        
        .progress-container.visible {
            display: block;
        }
        
        .progress-bar {
            height: 25px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00cc6a);
            border-radius: 12px;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            font-size: 0.9rem;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
        }
        
        /* Player info */
        .player-info {
            display: none;
            text-align: center;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .player-info.visible {
            display: block;
        }
        
        .player-info h2 {
            color: #00ff88;
            margin-bottom: 3px;
            font-size: 1.2rem;
        }
        
        .player-info .export-date {
            color: #666;
            font-size: 0.8rem;
        }
        
        /* Filters */
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .filter-group label {
            font-size: 0.8rem;
            color: #888;
        }
        
        .filter-group input, .filter-group select {
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 0.9rem;
        }
        
        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: #00ff88;
        }
        
        .filter-group input[type="text"] {
            min-width: 150px;
        }
        
        /* Pet Grid */
        .pet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 12px;
        }
        
        .pet-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border-radius: 10px;
            padding: 12px;
            display: flex;
            gap: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        
        .pet-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.3), transparent);
        }
        
        .pet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), 0 0 15px rgba(0, 255, 136, 0.1);
        }
        
        .pet-card.owned {
            border-left: 4px solid #00ff88;
        }
        
        .pet-card.missing {
            opacity: 0.6;
            border-left: 4px solid #666;
        }
        
        .pet-card.quality-0 { border-left-color: #9d9d9d; }
        .pet-card.quality-1 { border-left-color: #9d9d9d; }
        .pet-card.quality-2 { border-left-color: #ffffff; }
        .pet-card.quality-3 { border-left-color: #1eff00; }
        .pet-card.quality-4 { border-left-color: #0070dd; }
        .pet-card.quality-5 { border-left-color: #a335ee; }
        
        .pet-icon {
            width: 45px;
            height: 45px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            flex-shrink: 0;
        }
        
        .pet-info {
            flex: 1;
            min-width: 0;
        }
        
        .pet-name {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .pet-name .favorite { color: #ffd700; }
        .pet-name .owned-check { color: #00ff88; font-size: 0.9rem; }
        
        .pet-name.quality-0 { color: #9d9d9d; }
        .pet-name.quality-1 { color: #9d9d9d; }
        .pet-name.quality-2 { color: #ffffff; }
        .pet-name.quality-3 { color: #1eff00; }
        .pet-name.quality-4 { color: #0070dd; }
        .pet-name.quality-5 { color: #a335ee; }
        
        .pet-details {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 4px;
        }
        
        .pet-location {
            font-size: 0.75rem;
            color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .pet-stats {
            display: flex;
            gap: 8px;
            margin-top: 6px;
            font-size: 0.75rem;
        }
        
        .pet-stats span {
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .stat-health { color: #00ff88; }
        .stat-power { color: #ff6600; }
        .stat-speed { color: #00ccff; }
        
        .custom-name {
            font-size: 0.75rem;
            color: #ffd700;
            font-style: italic;
        }
        
        /* Pet count display */
        .pet-count {
            text-align: center;
            padding: 12px;
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        /* No results */
        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
            display: none;
        }
        
        /* Source type badges */
        .source-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 5px;
        }
        
        .source-wild { background: #2d5a27; color: #7fff7f; }
        .source-vendor { background: #5a4a27; color: #ffd700; }
        .source-drop { background: #5a2727; color: #ff7f7f; }
        .source-quest { background: #27455a; color: #7fbfff; }
        .source-achievement { background: #4a275a; color: #bf7fff; }
        .source-profession { background: #5a5427; color: #ffef7f; }
        .source-promo { background: #275a5a; color: #7fffff; }
        
        /* Zone filter pills */
        .zone-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 15px;
        }
        
        .zone-pill {
            padding: 5px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.3);
            color: #aaa;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .zone-pill:hover, .zone-pill.active {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            color: #00ff88;
        }
        
        /* Missing pets highlight */
        .show-missing .pet-card.owned {
            opacity: 0.4;
        }
        
        .show-missing .pet-card.missing {
            opacity: 1;
            border-left-color: #ff6b6b;
        }
        
        /* Checkbox filters */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        /* Upload toggle buttons */
        .upload-toggle {
            padding: 8px 20px;
            border: 2px solid #00ff88;
            background: transparent;
            color: #00ff88;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 0 5px;
            transition: all 0.2s;
        }
        
        .upload-toggle:hover {
            background: rgba(0, 255, 136, 0.1);
        }
        
        .upload-toggle.active {
            background: #00ff88;
            color: #1a1a2e;
        }
        
        /* Paste text area */
        #pasteInput {
            width: 100%;
            height: 150px;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.4);
            color: #fff;
            font-family: monospace;
            font-size: 0.85rem;
            resize: vertical;
            margin-bottom: 15px;
        }
        
        #pasteInput:focus {
            outline: none;
            border-color: #00ff88;
        }
        
        #pasteInput::placeholder {
            color: #666;
        }
        
        /* =====================================================
           LEADERBOARD STYLES
           ===================================================== */
        .leaderboard-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .leaderboard-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .leaderboard-header h2 {
            color: #ffd700;
            font-size: 1.8rem;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.4), 0 0 40px rgba(255, 215, 0, 0.2);
            letter-spacing: 1px;
        }
        
        .leaderboard-header h2::before,
        .leaderboard-header h2::after {
            content: '‚ú¶';
            margin: 0 15px;
            font-size: 0.8rem;
            vertical-align: middle;
        }
        
        .leaderboard-header p {
            color: #888;
            font-size: 0.9rem;
        }
        
        /* Personal Best Card */
        .personal-best-card {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 200, 100, 0.05));
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .personal-best-card.empty {
            border-color: rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
        }
        
        .personal-best-card h3 {
            color: #00ff88;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        
        .personal-best-card.empty h3 {
            color: #666;
        }
        
        .pb-score {
            font-size: 3rem;
            font-weight: bold;
            color: #00ff88;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        }
        
        .pb-details {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .pb-detail {
            text-align: center;
        }
        
        .pb-detail .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
        }
        
        .pb-detail .label {
            font-size: 0.75rem;
            color: #888;
        }
        
        .pb-meta {
            margin-top: 15px;
            font-size: 0.8rem;
            color: #666;
        }
        
        /* Submit Button */
        .submit-section {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .submit-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .submit-btn.primary {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #1a1a2e;
        }
        
        .submit-btn.primary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
        }
        
        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .copy-feedback {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #00ff88;
            color: #1a1a2e;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .copy-feedback.show {
            opacity: 1;
        }
        
        /* Leaderboard Table */
        .leaderboard-table-container {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.2));
            border-radius: 15px;
            padding: 20px;
            overflow-x: auto;
            border: 1px solid rgba(255, 215, 0, 0.1);
            position: relative;
        }
        
        .leaderboard-table-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 10%;
            right: 10%;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.4), transparent);
        }
        
        .leaderboard-table-container h3 {
            color: #ffd700;
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .leaderboard-table th {
            text-align: left;
            padding: 12px 15px;
            background: rgba(255, 215, 0, 0.1);
            color: #ffd700;
            font-size: 0.85rem;
            font-weight: bold;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
        }
        
        .leaderboard-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.9rem;
        }
        
        .leaderboard-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        .leaderboard-table .rank {
            font-weight: bold;
            width: 60px;
        }
        
        .leaderboard-table .rank-1 { 
            color: #ffd700; 
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        .leaderboard-table .rank-2 { 
            color: #c0c0c0; 
            text-shadow: 0 0 10px rgba(192, 192, 192, 0.5);
        }
        .leaderboard-table .rank-3 { 
            color: #cd7f32; 
            text-shadow: 0 0 10px rgba(205, 127, 50, 0.5);
        }
        
        .leaderboard-table .player-name {
            color: #00ff88;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }
        
        .leaderboard-table .score {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.1rem;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        .leaderboard-table .date {
            color: #666;
            font-size: 0.8rem;
        }
        
        .leaderboard-empty {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .leaderboard-empty p {
            margin-bottom: 10px;
        }
        
        /* Trophy icons */
        .trophy {
            font-size: 1.2rem;
            margin-right: 5px;
        }
        
        /* How it Works */
        .how-it-works {
            margin-top: 30px;
            padding: 20px;
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 10px;
        }
        
        .how-it-works h4 {
            color: #00ff88;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }
        
        .how-it-works ol {
            margin-left: 20px;
            color: #aaa;
            font-size: 0.85rem;
        }
        
        .how-it-works li {
            margin-bottom: 5px;
        }
        
        .disclaimer-small {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid rgba(255, 152, 0, 0.2);
            border-radius: 6px;
            font-size: 0.75rem;
            color: #ff9800;
        }
        
        /* Clickable player names in leaderboard */
        .player-name.clickable {
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .player-name.clickable:hover {
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        .player-name .view-icon {
            opacity: 0;
            margin-left: 5px;
            transition: opacity 0.2s;
        }
        .player-name.clickable:hover .view-icon {
            opacity: 1;
        }
        
        /* Collection Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 25px;
            max-width: 700px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close:hover {
            color: #ff6b6b;
        }
        .modal-content h2 {
            color: #00ff88;
            margin-bottom: 20px;
            padding-right: 30px;
        }
        .modal-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .modal-stat {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            min-width: 80px;
        }
        .modal-stat .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00ff88;
        }
        .modal-stat.score .value {
            color: #ffd700;
        }
        .modal-stat .label {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }
        .modal-pets {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        .modal-pet {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        .modal-pet.rare { border-left: 3px solid #1eff00; }
        .modal-pet.epic { border-left: 3px solid #0070dd; }
        .modal-pet.legendary { border-left: 3px solid #a335ee; }
        .modal-pet .pet-icon { font-size: 1.1rem; }
        .modal-pet .pet-name { flex: 1; color: #fff; }
        .modal-pet .pet-level { color: #888; font-size: 0.75rem; }
        .modal-pet.more {
            color: #888;
            font-style: italic;
            justify-content: center;
        }
        .modal-updated {
            text-align: center;
            color: #666;
            font-size: 0.8rem;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üêâ TauriPets</h1>
            <p class="subtitle">Battle Pet Collection Tracker for TauriWoW</p>
            <p class="disclaimer">‚ö†Ô∏è Unofficial fan project ¬∑ Not affiliated with TauriWoW or Crystalsong staff ¬∑ Use at your own risk</p>
            <div class="header-buttons">
                <a href="https://github.com/Kralomax/tauripets/releases/latest" class="download-btn" target="_blank">
                    üì¶ Download Addon
                </a>
                <a href="https://github.com/Kralomax/tauripets" class="github-btn" target="_blank">
                    ‚≠ê GitHub
                </a>
            </div>
        </header>
        
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="my-collection">üì¶ My Collection</button>
            <button class="tab-btn" data-tab="all-pets">üìö All Pets Database</button>
            <button class="tab-btn" data-tab="leaderboard">üèÜ Leaderboard</button>
        </div>
        
        <!-- Tab: My Collection -->
        <div id="my-collection" class="tab-content active">
            <div class="upload-area" id="uploadArea">
                <h2>üìÅ Load Your Collection</h2>
                
                <!-- Toggle buttons -->
                <div style="margin-bottom: 15px;">
                    <button class="upload-toggle active" id="toggleFile" onclick="showFileUpload()">Upload File</button>
                    <button class="upload-toggle" id="togglePaste" onclick="showPasteArea()">Paste Data</button>
                </div>
                
                <!-- File upload section -->
                <div id="fileSection">
                    <p>Drag & drop your <strong>.lua</strong> file here</p>
                    <p class="file-path">üìÇ WTF/Account/YOURNAME/SavedVariables/</p>
                    <input type="file" id="fileInput" accept=".lua,.bak">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Choose File</button>
                </div>
                
                <!-- Paste section (hidden by default) -->
                <div id="pasteSection" style="display: none;">
                    <p>In-game: Type <strong>/tpets copy</strong> ‚Üí Press <strong>Ctrl+A</strong> then <strong>Ctrl+C</strong> ‚Üí Paste below:</p>
                    <textarea id="pasteInput" placeholder="Paste your TAURIPETS data here..."></textarea>
                    <button class="upload-btn" onclick="processPastedData()">Load Collection</button>
                </div>
            </div>
            
            <div class="player-info" id="playerInfo">
                <h2 id="playerName">Player Name</h2>
                <div class="export-date" id="exportDate">Exported: --</div>
            </div>
            
            <!-- Score Display -->
            <div class="score-display" id="scoreDisplay">
                <div class="score-label">üèÜ PET SCORE</div>
                <div class="score-value" id="scoreValue">0</div>
                <div class="score-breakdown">
                    <div class="score-part">Quality: <span id="scoreQuality">0</span></div>
                    <div class="score-part">Levels: <span id="scoreLevels">0</span></div>
                    <div class="score-part">Bonuses: <span id="scoreBonuses">0</span></div>
                </div>
            </div>
            
            <!-- Achievements -->
            <div class="achievements" id="achievementsSection">
                <h3>üéñÔ∏è Achievements Unlocked</h3>
                <div class="achievement-list" id="achievementList"></div>
            </div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
            </div>
            
            <div class="stats-dashboard" id="statsDashboard">
                <div class="stat-card">
                    <div class="value" id="totalPets">0</div>
                    <div class="label">Total Pets</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="level25Pets">0</div>
                    <div class="label">Level 25</div>
                </div>
                <div class="stat-card rare">
                    <div class="value" id="rarePets">0</div>
                    <div class="label">Rare+</div>
                </div>
                <div class="stat-card epic">
                    <div class="value" id="epicPets">0</div>
                    <div class="label">Epic+</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="favoritePets">0</div>
                    <div class="label">‚≠ê Favorites</div>
                </div>
            </div>
            
            <div class="filters" id="myFilters" style="display: none;">
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" id="mySearchInput" placeholder="Pet name...">
                </div>
                <div class="filter-group">
                    <label>Quality</label>
                    <select id="myQualityFilter">
                        <option value="">All</option>
                        <option value="2">Uncommon+</option>
                        <option value="3">Rare+</option>
                        <option value="4">Epic+</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Level</label>
                    <select id="myLevelFilter">
                        <option value="">All</option>
                        <option value="25">Level 25</option>
                        <option value="20">Level 20+</option>
                        <option value="10">Level 10+</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Family</label>
                    <select id="myFamilyFilter">
                        <option value="">All Families</option>
                        <option value="1">Humanoid</option>
                        <option value="2">Dragonkin</option>
                        <option value="3">Flying</option>
                        <option value="4">Undead</option>
                        <option value="5">Critter</option>
                        <option value="6">Magic</option>
                        <option value="7">Elemental</option>
                        <option value="8">Beast</option>
                        <option value="9">Aquatic</option>
                        <option value="10">Mechanical</option>
                    </select>
                </div>
            </div>
            
            <div class="pet-count" id="myPetCount"></div>
            <div class="pet-grid" id="myPetGrid"></div>
            <div class="no-results" id="myNoResults">No pets match your filters</div>
        </div>
        
        <!-- Tab: All Pets Database -->
        <div id="all-pets" class="tab-content">
            <div class="filters">
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" id="allSearchInput" placeholder="Pet name...">
                </div>
                <div class="filter-group">
                    <label>Zone</label>
                    <select id="allZoneFilter">
                        <option value="">All Zones</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Source</label>
                    <select id="allSourceFilter">
                        <option value="">All Sources</option>
                        <option value="wild">Wild</option>
                        <option value="vendor">Vendor</option>
                        <option value="drop">Drop</option>
                        <option value="quest">Quest</option>
                        <option value="achievement">Achievement</option>
                        <option value="profession">Profession</option>
                        <option value="promo">Promotion</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Family</label>
                    <select id="allFamilyFilter">
                        <option value="">All Families</option>
                        <option value="1">Humanoid</option>
                        <option value="2">Dragonkin</option>
                        <option value="3">Flying</option>
                        <option value="4">Undead</option>
                        <option value="5">Critter</option>
                        <option value="6">Magic</option>
                        <option value="7">Elemental</option>
                        <option value="8">Beast</option>
                        <option value="9">Aquatic</option>
                        <option value="10">Mechanical</option>
                    </select>
                </div>
                <div class="filter-group checkbox-group">
                    <input type="checkbox" id="showMissingOnly">
                    <label for="showMissingOnly">Show Missing Only</label>
                </div>
            </div>
            
            <div class="pet-count" id="allPetCount">Loading pet database...</div>
            <div class="pet-grid" id="allPetGrid"></div>
            <div class="no-results" id="allNoResults">No pets match your filters</div>
        </div>
        
        <!-- Tab: Leaderboard -->
        <div id="leaderboard" class="tab-content">
            <div class="leaderboard-container">
                <div class="leaderboard-header">
                    <h2>üèÜ TauriPets Leaderboard</h2>
                    <p>Top pet collectors on TauriWoW</p>
                </div>
                
                <!-- Personal Best Card -->
                <div class="personal-best-card empty" id="personalBestCard">
                    <h3>üìä Your Personal Best</h3>
                    <div id="personalBestContent">
                        <p style="color: #666; margin: 20px 0;">Load your collection to see your score!</p>
                    </div>
                </div>
                
                <!-- Leaderboard Table -->
                <div class="leaderboard-table-container">
                    <h3>üåü Top Collectors</h3>
                    <table class="leaderboard-table" id="leaderboardTable">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Player</th>
                                <th>Score</th>
                                <th>Pets</th>
                                <th>Lv 25</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody">
                        </tbody>
                    </table>
                    <div class="leaderboard-empty" id="leaderboardEmpty">
                        <p>üèÜ No scores submitted yet!</p>
                        <p>Be the first to claim the top spot.</p>
                    </div>
                </div>
                
                <!-- How it Works -->
                <div class="how-it-works">
                    <h4>üìù How It Works</h4>
                    <ol>
                        <li>Load your collection in the <strong>My Collection</strong> tab</li>
                        <li>Your personal best is automatically saved locally</li>
                        <li>Click <strong>"Submit Score to Leaderboard"</strong> to share your score</li>
                        <li>Compete with other TauriWoW pet collectors!</li>
                    </ol>
                    <p class="disclaimer-small">‚ö†Ô∏è This is an unofficial fan project. Not affiliated with TauriWoW/Crystalsong. Data is stored on third-party servers. Use at your own risk.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Copy Feedback Toast -->
    <div class="copy-feedback" id="copyFeedback">‚úì Copied to clipboard!</div>
    
    <script>
        // =====================================================
        // PET DATABASE - All Legion Battle Pets
        // =====================================================
        const ALL_PETS_DATABASE = [
            // ============ BROKEN ISLES - AZSUNA ============
            { speciesID: 1708, name: "Coastal Sandpiper", family: 3, zone: "Azsuna", source: "wild", coords: "Various coastal areas", minLevel: 25, maxLevel: 25 },
            { speciesID: 1709, name: "Felspider", family: 8, zone: "Azsuna", source: "wild", coords: "Faronaar", minLevel: 25, maxLevel: 25 },
            { speciesID: 1710, name: "Olivetail Hare", family: 5, zone: "Azsuna", source: "wild", coords: "Various", minLevel: 25, maxLevel: 25 },
            { speciesID: 1711, name: "Risen Saber Kitten", family: 4, zone: "Azsuna", source: "wild", coords: "Ruins of Nar'thalas", minLevel: 25, maxLevel: 25 },
            { speciesID: 1712, name: "Juvenile Scuttleback", family: 9, zone: "Azsuna", source: "wild", coords: "Oceanus Cove", minLevel: 25, maxLevel: 25 },
            { speciesID: 1713, name: "Golden Eaglet", family: 3, zone: "Azsuna", source: "wild", coords: "Cliffs and peaks", minLevel: 25, maxLevel: 25 },
            
            // ============ BROKEN ISLES - VAL'SHARAH ============
            { speciesID: 1714, name: "Auburn Ringtail", family: 5, zone: "Val'sharah", source: "wild", coords: "Throughout zone", minLevel: 25, maxLevel: 25 },
            { speciesID: 1715, name: "Black-Footed Fox Kit", family: 8, zone: "Val'sharah", source: "wild", coords: "Dreamgrove area", minLevel: 25, maxLevel: 25 },
            { speciesID: 1716, name: "Gleamhoof Fawn", family: 8, zone: "Val'sharah", source: "wild", coords: "Forest areas", minLevel: 25, maxLevel: 25 },
            { speciesID: 1717, name: "Nightmare Treant", family: 7, zone: "Val'sharah", source: "wild", coords: "Nightmare areas", minLevel: 25, maxLevel: 25 },
            { speciesID: 1718, name: "Spring Strider", family: 9, zone: "Val'sharah", source: "wild", coords: "Near water", minLevel: 25, maxLevel: 25 },
            { speciesID: 1719, name: "Terror Larva", family: 8, zone: "Val'sharah", source: "wild", coords: "Nightmare areas", minLevel: 25, maxLevel: 25 },
            { speciesID: 1720, name: "Vale Flitter", family: 3, zone: "Val'sharah", source: "wild", coords: "Throughout zone", minLevel: 25, maxLevel: 25 },
            
            // ============ BROKEN ISLES - HIGHMOUNTAIN ============
            { speciesID: 1721, name: "Hog-Nosed Bat", family: 3, zone: "Highmountain", source: "wild", coords: "Cave areas", minLevel: 25, maxLevel: 25 },
            { speciesID: 1722, name: "Inland Croaker", family: 9, zone: "Highmountain", source: "wild", coords: "Near rivers/lakes", minLevel: 25, maxLevel: 25 },
            { speciesID: 1723, name: "Mudshell Conch", family: 9, zone: "Highmountain", source: "wild", coords: "Waterways", minLevel: 25, maxLevel: 25 },
            { speciesID: 1724, name: "Long-Eared Owl", family: 3, zone: "Highmountain", source: "wild", coords: "Forest areas", minLevel: 25, maxLevel: 25 },
            { speciesID: 1725, name: "Slithering Brownscale", family: 8, zone: "Highmountain", source: "wild", coords: "Various", minLevel: 25, maxLevel: 25 },
            { speciesID: 1726, name: "Snowfeather Hatchling", family: 3, zone: "Highmountain", source: "wild", coords: "Snowy peaks", minLevel: 25, maxLevel: 25 },
            
            // ============ BROKEN ISLES - STORMHEIM ============
            { speciesID: 1727, name: "Albatross Chick", family: 3, zone: "Stormheim", source: "wild", coords: "Coastal cliffs", minLevel: 25, maxLevel: 25 },
            { speciesID: 1728, name: "Fledgling Kingfeather", family: 3, zone: "Stormheim", source: "wild", coords: "Various", minLevel: 25, maxLevel: 25 },
            { speciesID: 1729, name: "Golden Retriever Pup", family: 8, zone: "Stormheim", source: "wild", coords: "Near Vrykul areas", minLevel: 25, maxLevel: 25 },
            { speciesID: 1730, name: "Grizzleback Fawn", family: 8, zone: "Stormheim", source: "wild", coords: "Forest areas", minLevel: 25, maxLevel: 25 },
            { speciesID: 1731, name: "Rose Taipan", family: 8, zone: "Stormheim", source: "wild", coords: "Rocky areas", minLevel: 25, maxLevel: 25 },
            { speciesID: 1732, name: "Shimmering Aquafly", family: 9, zone: "Stormheim", source: "wild", coords: "Near water", minLevel: 25, maxLevel: 25 },
            { speciesID: 1733, name: "Tiny Apparition", family: 4, zone: "Stormheim", source: "wild", coords: "Haunted areas", minLevel: 25, maxLevel: 25 },
            
            // ============ BROKEN ISLES - SURAMAR ============
            { speciesID: 1734, name: "Crystalline Broodling", family: 6, zone: "Suramar", source: "wild", coords: "Crystal areas", minLevel: 25, maxLevel: 25 },
            { speciesID: 1735, name: "Thornclaw Broodling", family: 8, zone: "Suramar", source: "wild", coords: "Falanaar", minLevel: 25, maxLevel: 25 },
            { speciesID: 1736, name: "Eldritch Manafiend", family: 6, zone: "Suramar", source: "wild", coords: "Mana-rich areas", minLevel: 25, maxLevel: 25 },
            { speciesID: 1737, name: "Arcane Gorger", family: 6, zone: "Suramar", source: "wild", coords: "Near leylines", minLevel: 25, maxLevel: 25 },
            { speciesID: 1738, name: "Stormborne Whelpling", family: 2, zone: "Suramar", source: "wild", coords: "Storm areas", minLevel: 25, maxLevel: 25 },
            
            // ============ BROKEN SHORE ============
            { speciesID: 1800, name: "Bile Larva", family: 8, zone: "Broken Shore", source: "wild", coords: "Various", minLevel: 25, maxLevel: 25 },
            { speciesID: 1801, name: "Vicious Broodling", family: 8, zone: "Broken Shore", source: "wild", coords: "Spider areas", minLevel: 25, maxLevel: 25 },
            { speciesID: 1802, name: "Grasping Manifestation", family: 6, zone: "Broken Shore", source: "wild", coords: "Fel areas", minLevel: 25, maxLevel: 25 },
            
            // ============ ARGUS - KROKUUN ============
            { speciesID: 1850, name: "Bile Larva", family: 8, zone: "Krokuun", source: "wild", coords: "Various", minLevel: 25, maxLevel: 25 },
            { speciesID: 1851, name: "Skittering Eel", family: 9, zone: "Krokuun", source: "wild", coords: "Water areas", minLevel: 25, maxLevel: 25 },
            { speciesID: 1852, name: "Flickering Argunite", family: 7, zone: "Krokuun", source: "wild", coords: "Crystal formations", minLevel: 25, maxLevel: 25 },
            
            // ============ ARGUS - MAC'AREE ============
            { speciesID: 1860, name: "Docile Skyfin", family: 3, zone: "Mac'Aree", source: "wild", coords: "Various", minLevel: 25, maxLevel: 25 },
            { speciesID: 1861, name: "Fel-Afflicted Skyfin", family: 3, zone: "Mac'Aree", source: "wild", coords: "Fel areas", minLevel: 25, maxLevel: 25 },
            { speciesID: 1862, name: "Void-Scarred Anubisath", family: 1, zone: "Mac'Aree", source: "wild", coords: "Ruins", minLevel: 25, maxLevel: 25 },
            
            // ============ ARGUS - ANTORAN WASTES ============
            { speciesID: 1870, name: "Antoran Bile Larva", family: 8, zone: "Antoran Wastes", source: "wild", coords: "Various", minLevel: 25, maxLevel: 25 },
            { speciesID: 1871, name: "Warped Scavenger", family: 8, zone: "Antoran Wastes", source: "wild", coords: "Fel pools", minLevel: 25, maxLevel: 25 },
            
            // ============ VENDOR PETS ============
            { speciesID: 1740, name: "Alliance Enthusiast", family: 1, zone: "Dalaran", source: "vendor", coords: "Breanni's Shop", minLevel: 1, maxLevel: 1 },
            { speciesID: 1741, name: "Horde Fanatic", family: 1, zone: "Dalaran", source: "vendor", coords: "Breanni's Shop", minLevel: 1, maxLevel: 1 },
            { speciesID: 1742, name: "Plump Turkey", family: 3, zone: "Dalaran", source: "vendor", coords: "Breanni's Shop", minLevel: 1, maxLevel: 1 },
            { speciesID: 1743, name: "Alarm-o-Bot", family: 10, zone: "Dalaran", source: "vendor", coords: "Engineering Supplies", minLevel: 1, maxLevel: 1 },
            { speciesID: 1885, name: "Ash'ana", family: 8, zone: "Val'sharah", source: "vendor", coords: "Dreamweavers - Revered", minLevel: 1, maxLevel: 1 },
            { speciesID: 1886, name: "Corgnelius", family: 8, zone: "Dalaran", source: "vendor", coords: "Breanni's Shop", minLevel: 1, maxLevel: 1 },
            { speciesID: 1887, name: "Firebat Pup", family: 3, zone: "Highmountain", source: "vendor", coords: "Highmountain Tribe - Revered", minLevel: 1, maxLevel: 1 },
            { speciesID: 1888, name: "Baby Elderhorn", family: 8, zone: "Highmountain", source: "vendor", coords: "Highmountain Tribe - Exalted", minLevel: 1, maxLevel: 1 },
            { speciesID: 1889, name: "Court Scribe", family: 1, zone: "Suramar", source: "vendor", coords: "The Nightfallen - Revered", minLevel: 1, maxLevel: 1 },
            { speciesID: 1890, name: "Extinguished Eye", family: 6, zone: "Suramar", source: "vendor", coords: "The Nightfallen - Exalted", minLevel: 1, maxLevel: 1 },
            
            // ============ DROP PETS ============
            { speciesID: 1750, name: "Nightmare Whelpling", family: 2, zone: "The Emerald Nightmare", source: "drop", coords: "Drops from bosses", minLevel: 1, maxLevel: 1 },
            { speciesID: 1751, name: "Corrupted Blood of Argus", family: 6, zone: "Antorus", source: "drop", coords: "Argus the Unmaker", minLevel: 1, maxLevel: 1 },
            { speciesID: 1752, name: "Stardust Bunny", family: 5, zone: "The Nighthold", source: "drop", coords: "Star Augur Etraeus", minLevel: 1, maxLevel: 1 },
            { speciesID: 1753, name: "Twilight Clutch-Sister", family: 2, zone: "The Nighthold", source: "drop", coords: "Elisande", minLevel: 1, maxLevel: 1 },
            { speciesID: 1754, name: "Scraps", family: 10, zone: "Return to Karazhan", source: "drop", coords: "Opera Hall", minLevel: 1, maxLevel: 1 },
            { speciesID: 1755, name: "Fiendish Imp", family: 6, zone: "Return to Karazhan", source: "drop", coords: "Illhoof", minLevel: 1, maxLevel: 1 },
            { speciesID: 1756, name: "Orphaned Felbat", family: 8, zone: "The Nighthold", source: "drop", coords: "Tichondrius", minLevel: 1, maxLevel: 1 },
            
            // ============ WORLD QUEST / RARE DROPS ============
            { speciesID: 1760, name: "Bleakwater Jelly", family: 9, zone: "Azsuna", source: "drop", coords: "World Quest reward", minLevel: 1, maxLevel: 1 },
            { speciesID: 1761, name: "Benax", family: 8, zone: "Suramar", source: "drop", coords: "Rare mob Baseleph", minLevel: 1, maxLevel: 1 },
            { speciesID: 1762, name: "Eye of Inquisition", family: 6, zone: "Azsuna", source: "drop", coords: "Rare mob Inquisitor Tivos", minLevel: 1, maxLevel: 1 },
            { speciesID: 1763, name: "Fledgling Oliveback", family: 3, zone: "Val'sharah", source: "drop", coords: "Rare mob", minLevel: 1, maxLevel: 1 },
            { speciesID: 1764, name: "Pygmy Owl", family: 3, zone: "Highmountain", source: "drop", coords: "Rare mob", minLevel: 1, maxLevel: 1 },
            { speciesID: 1765, name: "Sting Ray Pup", family: 9, zone: "Stormheim", source: "drop", coords: "Rare mob", minLevel: 1, maxLevel: 1 },
            
            // ============ ACHIEVEMENT PETS ============
            { speciesID: 1770, name: "Trunks", family: 8, zone: "Achievement", source: "achievement", coords: "Glory of the Legion Hero", minLevel: 1, maxLevel: 1 },
            { speciesID: 1771, name: "Nightmare Lasher", family: 7, zone: "Achievement", source: "achievement", coords: "Glory of the Legion Raider", minLevel: 1, maxLevel: 1 },
            { speciesID: 1772, name: "Wonderous Wisdomball", family: 6, zone: "Achievement", source: "achievement", coords: "Field Medic", minLevel: 1, maxLevel: 1 },
            
            // ============ PROFESSION PETS ============
            { speciesID: 1780, name: "Mechanical Axebeak", family: 10, zone: "Engineering", source: "profession", coords: "Legion Engineering craft", minLevel: 1, maxLevel: 1 },
            { speciesID: 1781, name: "Trigger", family: 10, zone: "Engineering", source: "profession", coords: "Legion Engineering craft", minLevel: 1, maxLevel: 1 },
            { speciesID: 1782, name: "Knockoff Blingtron", family: 10, zone: "Engineering", source: "profession", coords: "Legion Engineering craft", minLevel: 1, maxLevel: 1 },
            
            // ============ CLASS HALL PETS ============
            { speciesID: 1790, name: "Broot", family: 7, zone: "Class Hall", source: "quest", coords: "Druid Order Hall Campaign", minLevel: 1, maxLevel: 1 },
            { speciesID: 1791, name: "Snowfang", family: 8, zone: "Class Hall", source: "quest", coords: "Hunter Order Hall Campaign", minLevel: 1, maxLevel: 1 },
            { speciesID: 1792, name: "Ban-Fu, Cub of Ban-Lu", family: 8, zone: "Class Hall", source: "quest", coords: "Monk Order Hall Campaign", minLevel: 1, maxLevel: 1 },
            
            // ============ OLDER EXPANSION PETS (Common on TauriWoW) ============
            // Kalimdor Wild
            { speciesID: 379, name: "Squirrel", family: 5, zone: "Kalimdor", source: "wild", coords: "Various forests", minLevel: 1, maxLevel: 25 },
            { speciesID: 378, name: "Rabbit", family: 5, zone: "Eastern Kingdoms", source: "wild", coords: "Various", minLevel: 1, maxLevel: 25 },
            { speciesID: 447, name: "Fawn", family: 5, zone: "Teldrassil", source: "wild", coords: "Throughout zone", minLevel: 1, maxLevel: 5 },
            { speciesID: 452, name: "Red-Tailed Chipmunk", family: 5, zone: "Teldrassil", source: "wild", coords: "Throughout zone", minLevel: 1, maxLevel: 6 },
            { speciesID: 478, name: "Forest Moth", family: 3, zone: "Teldrassil", source: "wild", coords: "Throughout zone", minLevel: 3, maxLevel: 6 },
            { speciesID: 374, name: "Black Lamb", family: 5, zone: "Elwynn Forest", source: "wild", coords: "Near Goldshire", minLevel: 1, maxLevel: 8 },
            { speciesID: 68, name: "Great Horned Owl", family: 3, zone: "Teldrassil", source: "vendor", coords: "Darnassus", minLevel: 1, maxLevel: 1 },
            { speciesID: 72, name: "Snowshoe Rabbit", family: 5, zone: "Dun Morogh", source: "vendor", coords: "Ironforge", minLevel: 1, maxLevel: 1 },
            { speciesID: 138, name: "Blue Moth", family: 3, zone: "The Exodar", source: "vendor", coords: "The Exodar", minLevel: 1, maxLevel: 1 },
            
            // Pandaria
            { speciesID: 627, name: "Infected Squirrel", family: 4, zone: "Silverpine Forest", source: "wild", coords: "Various", minLevel: 3, maxLevel: 6 },
            
            // Draenor
            { speciesID: 1446, name: "Frostwolf Pup", family: 8, zone: "Frostfire Ridge", source: "wild", coords: "Throughout zone", minLevel: 23, maxLevel: 25 },
            { speciesID: 1447, name: "Icespine Hatchling", family: 8, zone: "Frostfire Ridge", source: "wild", coords: "Snowy areas", minLevel: 23, maxLevel: 25 },
            
            // ============ SPECIAL / RARE PETS ============
            { speciesID: 1895, name: "Sun Darter Hatchling", family: 2, zone: "Winterspring", source: "drop", coords: "Hidden cave puzzle", minLevel: 1, maxLevel: 1 },
            { speciesID: 1896, name: "Terky", family: 5, zone: "Borean Tundra", source: "drop", coords: "Hidden egg", minLevel: 1, maxLevel: 1 },
            { speciesID: 489, name: "Spawn of Onyxia", family: 2, zone: "Dustwallow Marsh", source: "wild", coords: "Wyrmbog", minLevel: 14, maxLevel: 15 },
            { speciesID: 496, name: "Rusty Snail", family: 5, zone: "Ashenvale", source: "wild", coords: "Zoram Strand", minLevel: 17, maxLevel: 18 },
        ];

        // =====================================================
        // SUPABASE CONFIGURATION
        // =====================================================
        const SUPABASE_URL = 'https://yxendhrzacondoyzfzlf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4ZW5kaHJ6YWNvbmRveXpmemxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0OTM2OTcsImV4cCI6MjA4MTA2OTY5N30.Pa2CA_AaB2GPAgKWmuUVyB7be1xTLUxqriy1iSO8b4g';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // =====================================================
        // LEADERBOARD DATA (fetched from Supabase)
        // =====================================================
        let LEADERBOARD_DATA = [];

        // =====================================================
        // COLLECTION STORAGE (Supabase)
        // =====================================================
        
        // Save collection to Supabase
        async function saveCollectionToSupabase(playerName, realmName, pets, score) {
            try {
                console.log('Saving collection to Supabase...');
                
                // Check if player already has a collection
                const { data: existing, error: checkError } = await supabase
                    .from('Collections')
                    .select('id')
                    .eq('player', playerName)
                    .eq('realm', realmName)
                    .single();
                
                const collectionData = {
                    player: playerName,
                    realm: realmName,
                    pets: pets,
                    score: score,
                    updated_at: new Date().toISOString()
                };
                
                let result;
                if (existing) {
                    // Update existing
                    result = await supabase
                        .from('Collections')
                        .update(collectionData)
                        .eq('id', existing.id);
                } else {
                    // Insert new
                    result = await supabase
                        .from('Collections')
                        .insert(collectionData);
                }
                
                if (result.error) {
                    console.error('Error saving collection:', result.error);
                    return false;
                }
                
                console.log('Collection saved successfully!');
                return true;
            } catch (err) {
                console.error('Failed to save collection:', err);
                return false;
            }
        }
        
        // Load collection from Supabase (for viewing other players)
        async function loadCollectionFromSupabase(playerName, realmName) {
            try {
                console.log(`Loading collection for ${playerName}-${realmName}...`);
                
                const { data, error } = await supabase
                    .from('Collections')
                    .select('*')
                    .eq('player', playerName)
                    .eq('realm', realmName)
                    .single();
                
                if (error) {
                    console.error('Error loading collection:', error);
                    return null;
                }
                
                return data;
            } catch (err) {
                console.error('Failed to load collection:', err);
                return null;
            }
        }

        // =====================================================
        // GLOBAL STATE
        // =====================================================
        let playerData = null;
        let ownedSpeciesIDs = new Set();
        let currentScoreData = null;
        
        const families = {
            1: { name: 'Humanoid', icon: 'üë§' },
            2: { name: 'Dragonkin', icon: 'üêâ' },
            3: { name: 'Flying', icon: 'ü¶Ö' },
            4: { name: 'Undead', icon: 'üíÄ' },
            5: { name: 'Critter', icon: 'üê∞' },
            6: { name: 'Magic', icon: '‚ú®' },
            7: { name: 'Elemental', icon: 'üî•' },
            8: { name: 'Beast', icon: 'üêæ' },
            9: { name: 'Aquatic', icon: 'üêü' },
            10: { name: 'Mechanical', icon: '‚öôÔ∏è' }
        };
        
        const qualities = {
            0: 'Poor', 1: 'Common', 2: 'Uncommon', 
            3: 'Rare', 4: 'Epic', 5: 'Legendary'
        };
        
        const sourceLabels = {
            wild: 'Wild', vendor: 'Vendor', drop: 'Drop',
            quest: 'Quest', achievement: 'Achievement', 
            profession: 'Profession', promo: 'Promo'
        };
        
        // Quality points for scoring (WarcraftPets-inspired)
        const QUALITY_POINTS = {
            0: 2,   // Poor
            1: 3,   // Common
            2: 4,   // Uncommon
            3: 5,   // Rare
            4: 7,   // Epic
            5: 12   // Legendary
        };
        
        // Achievement definitions
        const ACHIEVEMENTS = [
            { id: 'collect50', name: 'üì¶ Collector', desc: '50+ unique pets', check: (s) => s.uniqueCount >= 50, bonus: 100 },
            { id: 'collect100', name: 'üì¶ Dedicated', desc: '100+ unique pets', check: (s) => s.uniqueCount >= 100, bonus: 150 },
            { id: 'collect250', name: 'üì¶ Obsessed', desc: '250+ unique pets', check: (s) => s.uniqueCount >= 250, bonus: 250 },
            { id: 'collect500', name: 'üì¶ Insane', desc: '500+ unique pets', check: (s) => s.uniqueCount >= 500, bonus: 500 },
            { id: 'train10', name: '‚≠ê Trainer', desc: '10+ level 25 pets', check: (s) => s.level25Count >= 10, bonus: 200 },
            { id: 'train25', name: '‚≠ê Pro Trainer', desc: '25+ level 25 pets', check: (s) => s.level25Count >= 25, bonus: 300 },
            { id: 'train50', name: '‚≠ê Elite Trainer', desc: '50+ level 25 pets', check: (s) => s.level25Count >= 50, bonus: 500 },
            { id: 'families', name: 'üåç Zoologist', desc: 'All 10 families', check: (s) => s.familyCount >= 10, bonus: 100 },
            { id: 'rare25', name: 'üíé Quality Hunter', desc: '25+ rare or better', check: (s) => s.rareCount >= 25, bonus: 150 },
            { id: 'epic10', name: 'üíú Epic Collector', desc: '10+ epic or better', check: (s) => s.epicCount >= 10, bonus: 200 },
        ];

        // =====================================================
        // LEADERBOARD FUNCTIONS
        // =====================================================
        
        // Load personal best from localStorage
        function loadPersonalBest() {
            try {
                const saved = localStorage.getItem('tauripets_personal_best');
                return saved ? JSON.parse(saved) : null;
            } catch (e) {
                console.error('Error loading personal best:', e);
                return null;
            }
        }
        
        // Save personal best to localStorage (only if better)
        function savePersonalBest(scoreData, playerName, realmName) {
            try {
                const current = loadPersonalBest();
                const newEntry = {
                    player: playerName,
                    realm: realmName,
                    score: scoreData.total,
                    pets: scoreData.stats.uniqueCount,
                    level25: scoreData.stats.level25Count,
                    rare: scoreData.stats.rareCount,
                    epic: scoreData.stats.epicCount,
                    date: new Date().toISOString().split('T')[0],
                    timestamp: Date.now()
                };
                
                // Only save if it's a new personal best
                if (!current || newEntry.score > current.score) {
                    localStorage.setItem('tauripets_personal_best', JSON.stringify(newEntry));
                    return { saved: true, isNewBest: true, entry: newEntry };
                }
                
                return { saved: false, isNewBest: false, entry: current };
            } catch (e) {
                console.error('Error saving personal best:', e);
                return { saved: false, isNewBest: false, entry: null };
            }
        }
        
        // Render personal best card
        function renderPersonalBest() {
            const card = document.getElementById('personalBestCard');
            const content = document.getElementById('personalBestContent');
            const pb = loadPersonalBest();
            
            if (!pb) {
                card.classList.add('empty');
                content.innerHTML = `
                    <p style="color: #666; margin: 20px 0;">Load your collection to see your score!</p>
                `;
                return;
            }
            
            card.classList.remove('empty');
            content.innerHTML = `
                <div class="pb-score">${pb.score.toLocaleString()}</div>
                <div class="pb-details">
                    <div class="pb-detail">
                        <div class="value">${pb.pets}</div>
                        <div class="label">Unique Pets</div>
                    </div>
                    <div class="pb-detail">
                        <div class="value">${pb.level25}</div>
                        <div class="label">Level 25</div>
                    </div>
                    <div class="pb-detail">
                        <div class="value">${pb.rare || 0}</div>
                        <div class="label">Rare+</div>
                    </div>
                </div>
                <div class="pb-meta">
                    ${pb.player}-${pb.realm} ‚Ä¢ Best: ${pb.date}
                </div>
                <div class="submit-section">
                    <button class="submit-btn primary" onclick="submitScore()" ${!currentScoreData ? 'disabled' : ''}>
                        üèÜ Submit Score to Leaderboard
                    </button>
                </div>
            `;
        }
        
        // Submit score to leaderboard (Supabase integration placeholder)
        // Submit score to leaderboard (Supabase)
        async function submitScore() {
            const pb = loadPersonalBest();
            if (!pb) {
                alert('Load your collection first!');
                return;
            }
            
            // Use current session data if available, otherwise use personal best
            const data = currentScoreData ? {
                player: playerData.playerName,
                realm: playerData.realmName,
                score: currentScoreData.total,
                pets: currentScoreData.stats.uniqueCount,
                level25: currentScoreData.stats.level25Count,
                rare: currentScoreData.stats.rareCount,
                epic: currentScoreData.stats.epicCount
            } : pb;
            
            // Confirm submission
            if (!confirm(`Submit your score?\n\nPlayer: ${data.player}-${data.realm}\nScore: ${data.score.toLocaleString()}\nPets: ${data.pets}\nLevel 25: ${data.level25}`)) {
                return;
            }
            
            try {
                console.log('Submitting to Supabase:', data);
                
                // Check if player already has an entry
                const { data: existing, error: checkError } = await supabase
                    .from('Leaderboard')
                    .select('id, score')
                    .eq('player', data.player)
                    .eq('realm', data.realm)
                    .single();
                
                console.log('Existing entry check:', existing, checkError);
                
                if (existing && existing.score >= data.score) {
                    alert(`Your current leaderboard score (${existing.score.toLocaleString()}) is higher or equal!\n\nKeep collecting to beat your record.`);
                    return;
                }
                
                let result;
                if (existing) {
                    // Update existing entry
                    console.log('Updating existing entry...');
                    result = await supabase
                        .from('Leaderboard')
                        .update({
                            score: data.score,
                            pets: data.pets,
                            level25: data.level25,
                            rare: data.rare,
                            epic: data.epic,
                            created_at: new Date().toISOString()
                        })
                        .eq('id', existing.id);
                } else {
                    // Insert new entry
                    console.log('Inserting new entry...');
                    result = await supabase
                        .from('Leaderboard')
                        .insert({
                            player: data.player,
                            realm: data.realm,
                            score: data.score,
                            pets: data.pets,
                            level25: data.level25,
                            rare: data.rare,
                            epic: data.epic
                        });
                }
                
                console.log('Insert/Update result:', result);
                
                if (result.error) {
                    throw result.error;
                }
                
                // Success!
                showCopyFeedback();
                document.getElementById('copyFeedback').textContent = '‚úì Score submitted!';
                
                // Refresh the leaderboard
                await renderLeaderboard();
                
            } catch (err) {
                console.error('Submit error:', err);
                alert('Error submitting score: ' + (err.message || 'Unknown error'));
            }
        }
        
        // Show copy feedback toast
        function showCopyFeedback() {
            const feedback = document.getElementById('copyFeedback');
            feedback.classList.add('show');
            setTimeout(() => {
                feedback.classList.remove('show');
            }, 2500);
        }
        
        // Fetch leaderboard from Supabase
        async function fetchLeaderboard() {
            try {
                console.log('Fetching leaderboard from Supabase...');
                const { data, error } = await supabase
                    .from('Leaderboard')
                    .select('*')
                    .order('score', { ascending: false })
                    .limit(50);
                
                if (error) {
                    console.error('Supabase error:', error);
                    return [];
                }
                
                console.log('Leaderboard data:', data);
                return data || [];
            } catch (err) {
                console.error('Leaderboard fetch failed:', err);
                return [];
            }
        }
        
        // Render leaderboard table
        async function renderLeaderboard() {
            const tbody = document.getElementById('leaderboardBody');
            const empty = document.getElementById('leaderboardEmpty');
            
            // Show loading state
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#888;">Loading...</td></tr>';
            empty.style.display = 'none';
            
            // Fetch fresh data
            LEADERBOARD_DATA = await fetchLeaderboard();
            
            if (LEADERBOARD_DATA.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            
            tbody.innerHTML = LEADERBOARD_DATA.map((entry, index) => {
                const rank = index + 1;
                let trophy = '';
                let rankClass = '';
                
                if (rank === 1) { trophy = 'ü•á'; rankClass = 'rank-1'; }
                else if (rank === 2) { trophy = 'ü•à'; rankClass = 'rank-2'; }
                else if (rank === 3) { trophy = 'ü•â'; rankClass = 'rank-3'; }
                
                // Format date nicely
                const date = entry.created_at ? new Date(entry.created_at).toLocaleDateString() : 'N/A';
                
                return `
                    <tr>
                        <td class="rank ${rankClass}"><span class="trophy">${trophy}</span>${rank}</td>
                        <td class="player-name clickable" onclick="viewPlayerCollection('${entry.player}', '${entry.realm}')" title="Click to view collection">
                            ${entry.player}-${entry.realm}
                            <span class="view-icon">üëÅÔ∏è</span>
                        </td>
                        <td class="score">${entry.score.toLocaleString()}</td>
                        <td>${entry.pets}</td>
                        <td>${entry.level25}</td>
                        <td class="date">${date}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // View another player's collection
        async function viewPlayerCollection(playerName, realmName) {
            // Show loading modal
            const modal = document.getElementById('collectionModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = `${playerName}-${realmName}'s Collection`;
            modalBody.innerHTML = '<div style="text-align:center;padding:40px;color:#888;">Loading collection...</div>';
            modal.style.display = 'flex';
            
            // Fetch collection from Supabase
            const collection = await loadCollectionFromSupabase(playerName, realmName);
            
            if (!collection || !collection.pets || collection.pets.length === 0) {
                modalBody.innerHTML = `
                    <div style="text-align:center;padding:40px;">
                        <p style="color:#ff6b6b;font-size:1.2em;">‚ùå Collection not found</p>
                        <p style="color:#888;margin-top:10px;">This player hasn't uploaded their collection yet.</p>
                    </div>
                `;
                return;
            }
            
            // Calculate stats
            const pets = collection.pets;
            let level25 = 0, rareCount = 0, epicCount = 0;
            const familiesOwned = new Set();
            
            pets.forEach(pet => {
                if (pet.level === 25) level25++;
                if (pet.quality >= 3) rareCount++;
                if (pet.quality >= 4) epicCount++;
                if (pet.petType) familiesOwned.add(pet.petType);
            });
            
            // Sort pets by level desc, then quality desc
            pets.sort((a, b) => {
                if (b.level !== a.level) return b.level - a.level;
                return b.quality - a.quality;
            });
            
            // Render modal content
            modalBody.innerHTML = `
                <div class="modal-stats">
                    <div class="modal-stat">
                        <div class="value">${pets.length}</div>
                        <div class="label">Pets</div>
                    </div>
                    <div class="modal-stat">
                        <div class="value">${level25}</div>
                        <div class="label">Lv 25</div>
                    </div>
                    <div class="modal-stat">
                        <div class="value">${rareCount}</div>
                        <div class="label">Rare+</div>
                    </div>
                    <div class="modal-stat">
                        <div class="value">${familiesOwned.size}</div>
                        <div class="label">Families</div>
                    </div>
                    <div class="modal-stat score">
                        <div class="value">${collection.score ? collection.score.toLocaleString() : 'N/A'}</div>
                        <div class="label">Score</div>
                    </div>
                </div>
                <div class="modal-pets">
                    ${pets.slice(0, 50).map(pet => {
                        const qualityClass = ['poor', 'common', 'uncommon', 'rare', 'epic', 'legendary'][pet.quality] || 'common';
                        const familyIcon = families[pet.petType]?.icon || '‚ùì';
                        return `
                            <div class="modal-pet ${qualityClass}">
                                <span class="pet-icon">${familyIcon}</span>
                                <span class="pet-name">${pet.speciesName || 'Unknown'}</span>
                                <span class="pet-level">Lv ${pet.level}</span>
                            </div>
                        `;
                    }).join('')}
                    ${pets.length > 50 ? `<div class="modal-pet more">... and ${pets.length - 50} more pets</div>` : ''}
                </div>
                <div class="modal-updated">
                    Last updated: ${collection.updated_at ? new Date(collection.updated_at).toLocaleDateString() : 'Unknown'}
                </div>
            `;
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('collectionModal').style.display = 'none';
        }
        
        // Calculate pet score
        function calculateScore(pets) {
            if (!pets || pets.length === 0) return null;
            
            // Track unique species (best quality of each)
            const uniquePets = {};
            let level25Count = 0;
            const familiesOwned = new Set();
            let rareCount = 0;
            let epicCount = 0;
            
            for (const pet of pets) {
                const speciesID = pet.speciesID;
                const quality = typeof pet.quality === 'number' ? pet.quality : (pet.qualityID || 0);
                const level = pet.level || 1;
                const family = pet.petType || pet.familyID || 0;
                
                // Only keep highest quality of each species
                if (!uniquePets[speciesID] || quality > uniquePets[speciesID].quality ||
                    (quality === uniquePets[speciesID].quality && level > uniquePets[speciesID].level)) {
                    uniquePets[speciesID] = { quality, level, family };
                }
                
                if (level === 25) level25Count++;
                if (family) familiesOwned.add(family);
                if (quality >= 3) rareCount++;
                if (quality >= 4) epicCount++;
            }
            
            // Calculate score components
            let qualityScore = 0;
            let levelScore = 0;
            let totalLevels = 0;
            
            for (const speciesID in uniquePets) {
                const pet = uniquePets[speciesID];
                qualityScore += QUALITY_POINTS[pet.quality] || 2;
                levelScore += pet.level * 0.12;
                totalLevels += pet.level;
            }
            
            // Calculate achievement bonuses
            const stats = {
                uniqueCount: Object.keys(uniquePets).length,
                level25Count,
                familyCount: familiesOwned.size,
                rareCount,
                epicCount,
                totalLevels
            };
            
            let bonusScore = 0;
            const unlockedAchievements = [];
            
            for (const ach of ACHIEVEMENTS) {
                if (ach.check(stats)) {
                    bonusScore += ach.bonus;
                    unlockedAchievements.push(ach);
                }
            }
            
            const totalScore = Math.floor(qualityScore + levelScore + bonusScore);
            
            return {
                total: totalScore,
                qualityScore: Math.floor(qualityScore),
                levelScore: Math.floor(levelScore),
                bonusScore,
                stats,
                unlockedAchievements
            };
        }
        
        // Display score
        function displayScore(scoreData) {
            if (!scoreData) return;
            
            // Store current score data for Discord copy
            currentScoreData = scoreData;
            
            document.getElementById('scoreDisplay').classList.add('visible');
            document.getElementById('scoreValue').textContent = scoreData.total.toLocaleString();
            document.getElementById('scoreQuality').textContent = scoreData.qualityScore.toLocaleString();
            document.getElementById('scoreLevels').textContent = scoreData.levelScore.toLocaleString();
            document.getElementById('scoreBonuses').textContent = '+' + scoreData.bonusScore.toLocaleString();
            
            // Display achievements
            if (scoreData.unlockedAchievements.length > 0) {
                document.getElementById('achievementsSection').classList.add('visible');
                const list = document.getElementById('achievementList');
                list.innerHTML = scoreData.unlockedAchievements.map(ach => 
                    `<div class="achievement" title="${ach.desc}: +${ach.bonus}">${ach.name}</div>`
                ).join('');
            }
            
            // Auto-save personal best and update leaderboard display
            const result = savePersonalBest(scoreData, playerData.playerName, playerData.realmName);
            renderPersonalBest();
            
            if (result.isNewBest) {
                console.log('New personal best saved!', result.entry);
            }
        }

        // =====================================================
        // TAB NAVIGATION
        // =====================================================
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        // =====================================================
        // FILE/PASTE TOGGLE
        // =====================================================
        function showFileUpload() {
            document.getElementById('fileSection').style.display = 'block';
            document.getElementById('pasteSection').style.display = 'none';
            document.getElementById('toggleFile').classList.add('active');
            document.getElementById('togglePaste').classList.remove('active');
        }
        
        function showPasteArea() {
            document.getElementById('fileSection').style.display = 'none';
            document.getElementById('pasteSection').style.display = 'block';
            document.getElementById('toggleFile').classList.remove('active');
            document.getElementById('togglePaste').classList.add('active');
        }
        
        function processPastedData() {
            const text = document.getElementById('pasteInput').value.trim();
            if (!text) {
                alert('Please paste your TauriPets data first!');
                return;
            }
            
            try {
                // Check if it's the simple copy format
                if (text.startsWith('TAURIPETS:')) {
                    playerData = parseCopyFormat(text);
                } else if (text.includes('TauriPetsDB') || text.includes('TauriPetsGUI_Export')) {
                    // It's the Lua format
                    playerData = parseLuaFile(text);
                } else {
                    throw new Error('Unrecognized format. Make sure you copied from TauriPets addon.');
                }
                
                // Build set of owned species IDs
                ownedSpeciesIDs.clear();
                if (playerData.pets) {
                    playerData.pets.forEach(pet => {
                        if (pet.speciesID) ownedSpeciesIDs.add(pet.speciesID);
                    });
                }
                
                displayMyCollection();
                renderAllPets();
                
                // Save collection to Supabase (async, don't wait)
                if (playerData.playerName && playerData.pets.length > 0) {
                    const score = currentScoreData ? currentScoreData.total : 0;
                    saveCollectionToSupabase(
                        playerData.playerName,
                        playerData.realmName,
                        playerData.pets,
                        score
                    ).then(saved => {
                        if (saved) {
                            console.log('Collection synced to cloud!');
                        }
                    });
                }
                
                // Clear the paste area
                document.getElementById('pasteInput').value = '';
                
            } catch (err) {
                alert('Error parsing data: ' + err.message);
                console.error(err);
            }
        }
        
        function parseCopyFormat(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 1) throw new Error('Empty data');
            
            // Parse header: TAURIPETS:PlayerName:Realm:Date:Owned:Total:Score
            const header = lines[0].split(':');
            if (header[0] !== 'TAURIPETS') throw new Error('Invalid format');
            
            const data = {
                playerName: header[1] || 'Unknown',
                realmName: header[2] || 'TauriWoW',
                exportDate: header[3] || '',
                ownedPets: parseInt(header[4]) || 0,
                totalPets: parseInt(header[5]) || 0,
                addonScore: parseInt(header[6]) || 0, // Score calculated by addon
                pets: []
            };
            
            // Parse pet lines: speciesID|name|familyID|level|qualityID|health|power|speed|favorite
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const parts = line.split('|');
                if (parts.length >= 8) {
                    data.pets.push({
                        speciesID: parseInt(parts[0]) || 0,
                        speciesName: parts[1] || 'Unknown',
                        petType: parseInt(parts[2]) || 0,
                        level: parseInt(parts[3]) || 1,
                        quality: parseInt(parts[4]) || 0,
                        health: parseInt(parts[5]) || 0,
                        power: parseInt(parts[6]) || 0,
                        speed: parseInt(parts[7]) || 0,
                        favorite: parts[8] === '1'
                    });
                }
            }
            
            if (data.pets.length === 0) {
                throw new Error('No pets found in data');
            }
            
            return data;
        }

        // =====================================================
        // FILE UPLOAD HANDLING
        // =====================================================
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) processFile(file);
        });
        
        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    playerData = parseLuaFile(content);
                    
                    // Build set of owned species IDs
                    ownedSpeciesIDs.clear();
                    if (playerData.pets) {
                        playerData.pets.forEach(pet => {
                            if (pet.speciesID) ownedSpeciesIDs.add(pet.speciesID);
                        });
                    }
                    
                    displayMyCollection();
                    renderAllPets(); // Re-render to show owned status
                } catch (err) {
                    alert('Error parsing file: ' + err.message);
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }
        
        function parseLuaFile(content) {
            let match = content.match(/TauriPetsGUI_Export\s*=\s*\{/);
            let varName = 'TauriPetsGUI_Export';
            
            if (!match) {
                match = content.match(/TauriPetsDB\s*=\s*\{/);
                varName = 'TauriPetsDB';
            }
            
            if (!match) {
                throw new Error('Could not find pet data. Make sure you exported from TauriPetsGUI or TauriPetsExporter.');
            }
            
            const data = {
                playerName: '',
                realmName: '',
                exportDate: '',
                totalPets: 0,
                ownedPets: 0,
                pets: []
            };
            
            const playerMatch = content.match(/\["player"\]\s*=\s*"([^"]+)"/);
            if (playerMatch) {
                const parts = playerMatch[1].split('-');
                data.playerName = parts[0] || 'Unknown';
                data.realmName = parts.slice(1).join('-') || 'TauriWoW';
            }
            
            const dateMatch = content.match(/\["exportDate"\]\s*=\s*"([^"]+)"/);
            if (dateMatch) data.exportDate = dateMatch[1];
            
            const totalMatch = content.match(/\["totalPets"\]\s*=\s*(\d+)/);
            const maxMatch = content.match(/\["maxPets"\]\s*=\s*(\d+)/);
            if (totalMatch) data.ownedPets = parseInt(totalMatch[1]);
            if (maxMatch) data.totalPets = parseInt(maxMatch[1]);
            
            const petsSection = content.match(/\["pets"\]\s*=\s*\{([\s\S]*?)\},\s*\["player"\]/);
            if (!petsSection) {
                const altPetsSection = content.match(/\["pets"\]\s*=\s*\{([\s\S]+)\}\s*,?\s*\}/);
                if (altPetsSection) parsePetsFromSection(altPetsSection[1], data);
            } else {
                parsePetsFromSection(petsSection[1], data);
            }
            
            if (!data.ownedPets) data.ownedPets = data.pets.length;
            
            return data;
        }
        
        function parsePetsFromSection(petsContent, data) {
            const petBlocks = petsContent.split(/\},\s*--\s*\[\d+\]/);
            
            for (const block of petBlocks) {
                if (!block.trim() || !block.includes('speciesID')) continue;
                
                const pet = {};
                
                const stringFields = ['name', 'speciesName', 'customName', 'quality', 'family', 'petID', 'breed'];
                for (const field of stringFields) {
                    const match = block.match(new RegExp(`\\["${field}"\\]\\s*=\\s*"([^"]*)"`));
                    if (match) pet[field] = match[1];
                }
                
                const numberFields = ['speciesID', 'familyID', 'level', 'qualityID', 'health', 'power', 'speed', 'petType'];
                for (const field of numberFields) {
                    const match = block.match(new RegExp(`\\["${field}"\\]\\s*=\\s*(-?\\d+)`));
                    if (match) pet[field] = parseInt(match[1]);
                }
                
                const boolFields = ['favorite', 'canBattle', 'isTradeable', 'isUnique'];
                for (const field of boolFields) {
                    const match = block.match(new RegExp(`\\["${field}"\\]\\s*=\\s*(true|false)`));
                    if (match) pet[field] = match[1] === 'true';
                }
                
                if (!pet.speciesName && pet.name) pet.speciesName = pet.name;
                if (!pet.petType && pet.familyID) pet.petType = pet.familyID;
                if (pet.qualityID !== undefined) pet.quality = pet.qualityID;
                
                if (pet.speciesName || pet.name) data.pets.push(pet);
            }
        }

        // =====================================================
        // MY COLLECTION DISPLAY
        // =====================================================
        function displayMyCollection() {
            if (!playerData) return;
            
            document.getElementById('playerInfo').classList.add('visible');
            document.getElementById('progressContainer').classList.add('visible');
            document.getElementById('statsDashboard').classList.add('visible');
            document.getElementById('myFilters').style.display = 'flex';
            
            document.getElementById('playerName').textContent = 
                `${playerData.playerName} - ${playerData.realmName}`;
            document.getElementById('exportDate').textContent = 
                `Exported: ${playerData.exportDate || 'Unknown'}`;
            
            const pets = playerData.pets || [];
            const level25 = pets.filter(p => p.level === 25).length;
            const rare = pets.filter(p => {
                const q = typeof p.quality === 'number' ? p.quality : (p.qualityID || 0);
                return q >= 3;
            }).length;
            const epic = pets.filter(p => {
                const q = typeof p.quality === 'number' ? p.quality : (p.qualityID || 0);
                return q >= 4;
            }).length;
            const favorites = pets.filter(p => p.favorite).length;
            
            document.getElementById('totalPets').textContent = pets.length;
            document.getElementById('level25Pets').textContent = level25;
            document.getElementById('rarePets').textContent = rare;
            document.getElementById('epicPets').textContent = epic;
            document.getElementById('favoritePets').textContent = favorites;
            
            const totalPossible = playerData.totalPets || playerData.maxPets || 1000;
            const ownedCount = playerData.ownedPets || pets.length;
            const percentage = Math.min(100, (ownedCount / totalPossible * 100)).toFixed(1);
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = 
                `${ownedCount} / ${totalPossible} (${percentage}%)`;
            
            // Calculate and display score
            const scoreData = calculateScore(pets);
            displayScore(scoreData);
            
            renderMyPets();
            setupMyFilters();
        }
        
        function getMyFilteredPets() {
            if (!playerData || !playerData.pets) return [];
            
            let pets = [...playerData.pets];
            
            const search = document.getElementById('mySearchInput').value.toLowerCase();
            if (search) {
                pets = pets.filter(p => 
                    (p.speciesName && p.speciesName.toLowerCase().includes(search)) ||
                    (p.customName && p.customName.toLowerCase().includes(search))
                );
            }
            
            const quality = document.getElementById('myQualityFilter').value;
            if (quality) {
                const minQuality = parseInt(quality);
                pets = pets.filter(p => {
                    const petQuality = typeof p.quality === 'number' ? p.quality : (p.qualityID || 0);
                    return petQuality >= minQuality;
                });
            }
            
            const level = document.getElementById('myLevelFilter').value;
            if (level) {
                pets = pets.filter(p => p.level >= parseInt(level));
            }
            
            const family = document.getElementById('myFamilyFilter').value;
            if (family) {
                const familyId = parseInt(family);
                pets = pets.filter(p => (p.petType || p.familyID) === familyId);
            }
            
            pets.sort((a, b) => {
                if (a.favorite !== b.favorite) return b.favorite ? 1 : -1;
                if (a.level !== b.level) return (b.level || 0) - (a.level || 0);
                const aQuality = typeof a.quality === 'number' ? a.quality : (a.qualityID || 0);
                const bQuality = typeof b.quality === 'number' ? b.quality : (b.qualityID || 0);
                if (aQuality !== bQuality) return bQuality - aQuality;
                return (a.speciesName || '').localeCompare(b.speciesName || '');
            });
            
            return pets;
        }
        
        function renderMyPets() {
            const grid = document.getElementById('myPetGrid');
            const pets = getMyFilteredPets();
            
            document.getElementById('myPetCount').textContent = `Showing ${pets.length} pets`;
            document.getElementById('myNoResults').style.display = pets.length === 0 ? 'block' : 'none';
            
            grid.innerHTML = pets.map(pet => {
                const familyId = pet.petType || pet.familyID || 0;
                const family = families[familyId] || { name: pet.family || 'Unknown', icon: '‚ùì' };
                
                let qualityNum = 0;
                let qualityName = 'Unknown';
                if (typeof pet.quality === 'number') {
                    qualityNum = pet.quality;
                    qualityName = qualities[qualityNum] || 'Unknown';
                } else if (pet.qualityID !== undefined) {
                    qualityNum = pet.qualityID;
                    qualityName = pet.quality || qualities[qualityNum] || 'Unknown';
                } else if (typeof pet.quality === 'string') {
                    qualityName = pet.quality;
                    for (const [num, name] of Object.entries(qualities)) {
                        if (name === pet.quality) {
                            qualityNum = parseInt(num);
                            break;
                        }
                    }
                }
                
                return `
                    <div class="pet-card quality-${qualityNum}">
                        <div class="pet-icon">${family.icon}</div>
                        <div class="pet-info">
                            <div class="pet-name quality-${qualityNum}">
                                ${pet.favorite ? '<span class="favorite">‚≠ê</span>' : ''}
                                ${pet.speciesName || pet.name || 'Unknown Pet'}
                                ${pet.breed && pet.breed !== 'Unknown' ? `<span style="color:#888;font-size:0.75rem">(${pet.breed})</span>` : ''}
                            </div>
                            ${pet.customName ? `<div class="custom-name">"${pet.customName}"</div>` : ''}
                            <div class="pet-details">
                                Level ${pet.level || 1} ${qualityName} ${family.name}
                            </div>
                            <div class="pet-stats">
                                <span class="stat-health">‚ù§Ô∏è ${pet.health || 0}</span>
                                <span class="stat-power">‚öîÔ∏è ${pet.power || 0}</span>
                                <span class="stat-speed">‚ö° ${pet.speed || 0}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function setupMyFilters() {
            document.getElementById('mySearchInput').addEventListener('input', renderMyPets);
            document.getElementById('myQualityFilter').addEventListener('change', renderMyPets);
            document.getElementById('myLevelFilter').addEventListener('change', renderMyPets);
            document.getElementById('myFamilyFilter').addEventListener('change', renderMyPets);
        }

        // =====================================================
        // ALL PETS DATABASE DISPLAY
        // =====================================================
        function populateZoneFilter() {
            const zones = [...new Set(ALL_PETS_DATABASE.map(p => p.zone))].sort();
            const select = document.getElementById('allZoneFilter');
            zones.forEach(zone => {
                const option = document.createElement('option');
                option.value = zone;
                option.textContent = zone;
                select.appendChild(option);
            });
        }
        
        function getAllFilteredPets() {
            let pets = [...ALL_PETS_DATABASE];
            
            const search = document.getElementById('allSearchInput').value.toLowerCase();
            if (search) {
                pets = pets.filter(p => p.name.toLowerCase().includes(search));
            }
            
            const zone = document.getElementById('allZoneFilter').value;
            if (zone) {
                pets = pets.filter(p => p.zone === zone);
            }
            
            const source = document.getElementById('allSourceFilter').value;
            if (source) {
                pets = pets.filter(p => p.source === source);
            }
            
            const family = document.getElementById('allFamilyFilter').value;
            if (family) {
                pets = pets.filter(p => p.family === parseInt(family));
            }
            
            const showMissingOnly = document.getElementById('showMissingOnly').checked;
            if (showMissingOnly && ownedSpeciesIDs.size > 0) {
                pets = pets.filter(p => !ownedSpeciesIDs.has(p.speciesID));
            }
            
            // Sort: owned first (if collection loaded), then by zone, then by name
            pets.sort((a, b) => {
                const aOwned = ownedSpeciesIDs.has(a.speciesID);
                const bOwned = ownedSpeciesIDs.has(b.speciesID);
                if (aOwned !== bOwned) return bOwned ? 1 : -1;
                if (a.zone !== b.zone) return a.zone.localeCompare(b.zone);
                return a.name.localeCompare(b.name);
            });
            
            return pets;
        }
        
        function renderAllPets() {
            const grid = document.getElementById('allPetGrid');
            const pets = getAllFilteredPets();
            
            const ownedCount = pets.filter(p => ownedSpeciesIDs.has(p.speciesID)).length;
            const statusText = ownedSpeciesIDs.size > 0 
                ? `Showing ${pets.length} pets (${ownedCount} owned, ${pets.length - ownedCount} missing)`
                : `Showing ${pets.length} pets (upload your collection to track progress!)`;
            
            document.getElementById('allPetCount').textContent = statusText;
            document.getElementById('allNoResults').style.display = pets.length === 0 ? 'block' : 'none';
            
            grid.innerHTML = pets.map(pet => {
                const family = families[pet.family] || { name: 'Unknown', icon: '‚ùì' };
                const isOwned = ownedSpeciesIDs.has(pet.speciesID);
                const sourceClass = `source-${pet.source}`;
                
                return `
                    <div class="pet-card ${isOwned ? 'owned' : 'missing'}">
                        <div class="pet-icon">${family.icon}</div>
                        <div class="pet-info">
                            <div class="pet-name" style="color: ${isOwned ? '#00ff88' : '#aaa'}">
                                ${isOwned ? '<span class="owned-check">‚úì</span>' : ''}
                                ${pet.name}
                                <span class="source-badge ${sourceClass}">${sourceLabels[pet.source]}</span>
                            </div>
                            <div class="pet-details">
                                ${family.name} ‚Ä¢ Level ${pet.minLevel}${pet.maxLevel !== pet.minLevel ? '-' + pet.maxLevel : ''}
                            </div>
                            <div class="pet-location">üìç ${pet.zone} - ${pet.coords}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function setupAllFilters() {
            document.getElementById('allSearchInput').addEventListener('input', renderAllPets);
            document.getElementById('allZoneFilter').addEventListener('change', renderAllPets);
            document.getElementById('allSourceFilter').addEventListener('change', renderAllPets);
            document.getElementById('allFamilyFilter').addEventListener('change', renderAllPets);
            document.getElementById('showMissingOnly').addEventListener('change', renderAllPets);
        }

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            populateZoneFilter();
            setupAllFilters();
            renderAllPets();
            renderPersonalBest();
            renderLeaderboard();
        });
    </script>
    <!-- Collection View Modal -->
    <div id="collectionModal" class="modal" onclick="if(event.target===this)closeModal()">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">‚úï</button>
            <h2 id="modalTitle">Player Collection</h2>
            <div id="modalBody">Loading...</div>
        </div>
    </div>
</body>
</html>
